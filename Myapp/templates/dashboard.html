{% extends 'base.html' %}
{% block title %}Dashboard - Smart Expense Tracker{% endblock %}
{% load static %}
{% block content %}

<section class="max-w-7xl mx-auto p-6 text-white">
  <h1 class="text-4xl font-bold mb-6 text-center">Expense Dashboard</h1>

  <!-- üí∞ Budget & Summary Section -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-gray-900 p-6 rounded-2xl shadow-md flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Total Expenses</h2>
        <p class="text-3xl font-bold text-red-400">‚Çπ{{ total_expenses }}</p>
      </div>
      <a href="{% url 'home' %}#add-expense" 
         class="mt-4 inline-block bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-semibold text-center">
        Add Expense
      </a>
    </div>

    <!-- üßæ Remaining Balance Section (Updated) -->
    <div class="bg-gray-900 p-6 rounded-2xl shadow-md">
  <h2 class="text-xl font-semibold mb-2">Remaining Balance</h2>

  {% if remaining_balance < 0 %}
    <p class="text-3xl font-bold text-red-500">‚Çπ{{ remaining_balance }}</p>
    <p class="text-red-400 font-semibold mt-2">‚ö†Ô∏è You are running out of budget!</p>
  {% else %}
    <p class="text-3xl font-bold text-green-400">‚Çπ{{ remaining_balance }}</p>
  {% endif %}

  <!-- üìä Show % spent -->
  <p class="mt-2 text-gray-400">
    <span class="font-semibold text-blue-400">{{ spent_percent }}%</span> of your budget spent
  </p>

  <!-- üü¶ Progress Bar -->
  <div class="w-full bg-gray-800 rounded-full h-3 mt-2">
    <div
      class="h-3 rounded-full transition-all duration-500 
      {% if spent_percent < 70 %}
        bg-green-500
      {% elif spent_percent < 90 %}
        bg-yellow-500
      {% else %}
        bg-red-500
      {% endif %}"
      style="width: {{ spent_percent }}%;">
    </div>
  </div>
</div>

<!-- üí∞ Set Monthly Budget Card -->
<!-- üíº Monthly Budget Card -->
<div class="bg-gray-900 p-6 rounded-2xl shadow-md flex flex-col items-center justify-center text-center h-56 text-white">

  <h2 class="text-xl font-semibold mb-3 text-gray-300">Monthly Budget</h2>

  <!-- üíµ Current Budget -->
  <p class="text-4xl font-bold text-green-400 mb-2">‚Çπ{{ monthly_budget }}</p>

  <!-- ‚ú® Hidden Form -->
  <form 
    id="budgetForm"
    action="{% url 'set_budget' %}" 
    method="POST" 
    class="hidden flex flex-col items-center gap-2 w-full transition-all duration-300"
  >
    {% csrf_token %}
    <input 
      type="number" 
      name="budget" 
      placeholder="Enter new budget (‚Çπ)" 
      required 
      class="w-3/4 px-3 py-2 bg-gray-800 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300"
    />
    <button 
      type="submit" 
      class="px-1 py-1 bg-blue-600 hover:bg-blue-500 rounded-lg font-medium shadow-md transition duration-300 w-3/4"
    >
      Save
    </button>
  </form>

  <!-- ‚öôÔ∏è Toggle Button -->
  <button 
    id="toggleBudgetBtn"
    class="mt-2 px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded-lg font-semibold shadow-md transition duration-300"
  >
    Set New Budget
  </button>

</div>


  </div>

  <!-- üìä Chart Section with Toggle -->
  <div class="bg-gray-900 p-6 rounded-2xl shadow-md mb-6 w-full md:w-5/6 mx-auto">
    <div class="flex justify-center gap-4 mb-4">
      <button class="chart-toggle bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold active" data-target="category">Category</button>
      <button class="chart-toggle bg-green-500 hover:bg-green-700 px-4 py-2 rounded font-semibold" data-target="weekly">Weekly</button>
      <button class="chart-toggle bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded font-semibold" data-target="monthly">Monthly</button>
    </div>

    <div class="flex justify-center">
      <canvas id="mergedChart" class="mx-auto"></canvas>
    </div>

    <!-- üìã Category Legend with Pie Chart Colors -->
    <div id="category-legend" class="mt-6">
      <h3 class="text-xl font-semibold mb-4 text-center">Category-wise Totals</h3>
      <div class="flex flex-wrap justify-center gap-4">
        {% for label, value, color in category_totals %}
        <div class="flex items-center gap-2 bg-gray-800 px-4 py-2 rounded shadow-md">
          <span class="w-4 h-4 rounded-full" style="background-color: {{ color }};"></span>
          <span class="text-white font-semibold">{{ label }}: ‚Çπ{{ value }}</span>
        </div>
        {% empty %}
        <p class="text-gray-400 text-center w-full">No data found.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- üßæ Recent Transactions -->
  <h2 class="text-2xl font-bold mb-3">Recent Transactions</h2>

  <!-- üîΩ Month Filter -->
  <form id="filter-form" method="get" class="mb-4">
    <label for="month" class="text-white font-medium">Filter by Month:</label>
    <select name="month" id="month" class="ml-2 p-2 rounded bg-gray-800 text-white">
      <option value="all" {% if selected_month == 'all' %}selected{% endif %}>All</option>
      {% for m in month_names %}
      <option value="{{ forloop.counter }}" {% if selected_month == forloop.counter|stringformat:'s' %}selected{% endif %}>
        {{ m }}
      </option>
      {% endfor %}
    </select>
  </form>

  <!-- üí∞ Transactions Table -->
  <div id="transactions-table" class="overflow-x-auto bg-gray-900 rounded-lg shadow-md">
    <table class="min-w-full text-left text-white">
      <thead class="bg-gray-800">
        <tr>
          <th class="p-3">Date</th>
          <th class="p-3">Category</th>
          <th class="p-3">Description</th>
          <th class="p-3">Amount (‚Çπ)</th>
          <th class="p-3 text-center">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expenses %}
        <tr class="border-b border-gray-700 hover:bg-gray-800 transition">
          <td class="p-3">{{ expense.date }}</td>
          <td class="p-3">{{ expense.category }}</td>
          <td class="p-3">{{ expense.merchant }}</td>
          <td class="p-3">{{ expense.amount }}</td>
          <td class="p-3 text-center">
            <button class="text-red-400 hover:text-red-600 font-semibold delete-btn" data-id="{{ expense.id }}">
              Delete
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="p-3 text-center text-gray-400">No transactions found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- üìä ChartJS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>
let mergedChart;
const ctx = document.getElementById('mergedChart').getContext('2d');

const chartData = {
  category: {
    type: 'pie',
    data: {
      labels: {{ category_labels|safe }},
      datasets: [{
        data: {{ category_values|safe }},
        backgroundColor: {{ category_colors|safe }},
      }]
    },
    options: {
      plugins: {
        legend: { display: false },
        datalabels: {
          display:false
        }
      },
      cutout: '40%',
      radius: '100%'
    },
    plugins: [ChartDataLabels]
  },
  weekly: {
    type: 'bar',
    data: {
      labels: {{ week_labels|safe }},
      datasets: [{
        label: "Weekly Expenses (‚Çπ)",
        data: {{ week_values|safe }},
        backgroundColor: "rgba(0, 122, 73)"
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  },
  monthly: {
    type: 'bar',
    data: {
      labels: {{ month_names|safe }},
      datasets: [{
        label: "Monthly Expenses (‚Çπ)",
        data: {{ month_values|safe }},
        backgroundColor: 'rgba(128, 0, 199)',
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  }
};

function renderChart(type) {
  if (mergedChart) mergedChart.destroy();

  // Adjust canvas height for pie chart (smaller and centered)
  if (type === 'category') {
    ctx.canvas.height = 180; 
    ctx.canvas.width = 180;
  } else {
    ctx.canvas.height = 320;
    ctx.canvas.width = ctx.canvas.parentElement.offsetWidth;
  }

  mergedChart = new Chart(ctx, chartData[type]);

  // Active button highlight
  document.querySelectorAll('.chart-toggle').forEach(btn => btn.classList.remove('active'));
  document.querySelector(`.chart-toggle[data-target="${type}"]`).classList.add('active');
}

// Initial render
renderChart('category');

// Toggle buttons
document.querySelectorAll('.chart-toggle').forEach(btn => {
  btn.addEventListener('click', () => {
    renderChart(btn.dataset.target);
  });
});

// üóëÔ∏è Delete button AJAX
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('delete-btn')) {
    const id = e.target.dataset.id;
    fetch(`/delete-expense/${id}/`).then(() => location.reload());
  }
});

// üîΩ Month Filter AJAX
document.getElementById('month').addEventListener('change', function() {
  fetch(`?month=${this.value}`)
    .then(res => res.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      document.querySelector('#transactions-table').innerHTML =
        doc.querySelector('#transactions-table').innerHTML;
    });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const toggleBtn = document.getElementById("toggleBudgetBtn");
  const form = document.getElementById("budgetForm");

  toggleBtn.addEventListener("click", () => {
    form.classList.toggle("hidden");
    if (!form.classList.contains("hidden")) {
      toggleBtn.textContent = "Cancel";
    } else {
      toggleBtn.textContent = "Set New Budget";
    }
  });
});
</script>

<style>
.chart-toggle.active {
  border: 2px solid white;
}
</style>

{% endblock %}
