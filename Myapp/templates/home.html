{% extends 'base.html' %}
{% block title %}Home - Smart Expense Tracker{% endblock %}
{% load static %}
{% block content %}

<!-- Hero Section -->
<section class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-10 items-center w-full h-full px-6 py-12">
  <div class="flex flex-col gap-6">
    <h2 class="text-5xl sm:text-6xl font-extrabold leading-tight">Now Manage your expenses smartly!</h2>
    <p class="text-lg opacity-90 max-w-xl">Simply let Smart Expense Tracker automatically add it to your expenses list.</p>
    <div class="flex flex-wrap gap-4">
      <a href="#upload-section" class="px-6 py-3 rounded-lg font-semibold glass-card shadow-lg border border-white/10 hover:border-white/30">Get Started</a>
      <a href="{% url 'dashboard' %}" class="px-6 py-3 rounded-lg font-medium border border-white/20 hover:border-white/40">View Dashboard</a>
    </div>
    <div class="flex flex-wrap gap-3 mt-4">
      <span id="time" class="px-3 py-1 rounded-full glass-card text-sm border border-white/10">Time : --:-- hrs</span>
      <span id="day" class="px-3 py-1 rounded-full glass-card text-sm border border-white/10">Day : --</span>
      <span id="date" class="px-3 py-1 rounded-full glass-card text-sm border border-white/10">Date : --/--/----</span>
    </div>
  </div>

  <div class="flex flex-col items-center gap-4">
    <img src="{% static 'Sources/png_bg.jpg' %}" alt="Hero Image" class="w-full max-w-md rounded-2xl shadow-lg object-cover">
  </div>
</section>

<!-- Upload / Add Expense Section -->
<div id="upload-section" class="upload-section flex justify-center px-4 py-12">
  <div class="w-full md:w-4/5 flex flex-col gap-6">
    <div class="flex flex-col md:flex-row gap-6">

      <!-- Left: Upload Screenshot (Compact + Loader) -->
<div class="w-full md:w-1/2 p-6 glass-card rounded-2xl shadow-2xl text-center border border-white/10 justify-center items-center flex flex-col relative">
  <div id="uploadContainer" class="w-72 sm:w-80 py-16 sm:py-20 h-80 sm:h-80 rounded-lg bg-gradient-to-br from-white/6 to-white/2 flex flex-col items-center justify-center cursor-pointer hover:bg-white/10 transition transform hover:scale-105 border border-white relative">
   <div id="uploadContent" class="flex flex-col items-center justify-center">
    <img src="{% static 'Sources/upload.png' %}" alt="Upload" class="w-24 sm:w-28 mb-2">
    <span class="text-white font-medium">Upload Payment Screenshot</span>
    <input type="file" id="uploadInput" accept="image/*" class="hidden">
   </div>

    <div id="ocrResult" class="mt-4 p-4 border border-white/20 rounded-lg bg-white/90 text-white shadow-lg hidden w-72 mx-auto">  
       <h4 class="font-semibold mb-2">Extracted Details:</h4>
       <p><strong>Merchant:</strong> <span id="merchant"></span></p>
       <p><strong>Amount:</strong> ‚Çπ<span id="amount"></span></p>
      
       <p><strong>Category:</strong> <span id="category"></span></p>
    </div>


    <!-- Upload Overlay with Spinner -->
    <div id="uploadOverlay" class="absolute inset-0 bg-black flex flex-col items-center justify-center text-white font-semibold text-lg rounded-lg opacity-0 pointer-events-none transition-opacity">
      <svg class="animate-spin h-8 w-8 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      Uploading...
    </div>
  </div>
</div>


      <!-- Right: Add Expense Manually -->
      <div class="w-full md:w-1/2 p-6 glass-card rounded-2xl shadow-2xl border border-white/10 relative">
        <!-- Floating Success Modal -->
        <div id="floatingModal" class="absolute left-1/2 -translate-x-1/2 bottom-20 opacity-0 transition-all duration-500 transform -translate-y-2 text-center p-3 rounded-lg bg-green-600 text-white font-semibold shadow-lg w-max sm:w-auto z-50">
          ‚úÖ Expense Added Successfully!
          <button id="viewDashboardBtn" class="mt-2 px-4 py-2 bg-blue-500 hover:bg-blue-700 rounded-lg text-white font-medium text-sm">
            View Dashboard
          </button>
        </div>

        <form id="expenseForm" method="POST" action="{% url 'add_expense' %}" class="flex flex-col gap-4 text-left">
          {% csrf_token %}
          
          <label class="text-sm font-medium">Select Date:</label>
          <input type="date" name="date" id="expense-date" class="w-full p-3 rounded-lg glass-card text-white border border-white/10" required/>

          <label class="text-sm font-medium">Category:</label>
          <select name="category" id="category" class="w-full p-3 rounded-lg glass-card text-white border border-white/10 bg-grey focus:ring-2 focus:ring-white/30 transition-all duration-300" required>
            <option value="" disabled selected>Select category</option>
            <option value="Food" class="text-black">üçΩÔ∏è Food</option>
            <option value="Travel" class="text-black">üöó Travel</option>
            <option value="Shopping" class="text-black">üõçÔ∏è Shopping</option>
            <option value="Personal" class="text-black">üíº Personal</option>
          </select>

          <label class="text-sm font-medium">Amount:</label>
          <input type="number" name="amount" id="amount" placeholder="Enter amount" class="w-full p-3 rounded-lg glass-card text-white border border-white/10" required/>

          <label class="text-sm font-medium">Description:</label>
          <input type="text" name="description" id="Description" placeholder="Enter Description" class="w-full p-3 rounded-lg glass-card text-white border border-white/10" required/>

          <button type="submit" class="w-full mt-6">
            <div id="addExpenseBtn" class="h-14 text-xl rounded-lg flex items-center justify-center border border-white/20 hover:bg-white hover:text-black transition duration-300">
              Add Expense
            </div>
          </button>
        </form>
      </div>

    </div>

    <!-- View Dashboard Button Below Both -->
    <div class="flex justify-center mt-4">
      <a href="{% url 'dashboard' %}" class="px-8 py-3 rounded-lg font-medium bg-green-600 border border-white/20 hover:border-white/40">View Dashboard</a>
    </div>

  </div>
</div>

<!-- ‚úÖ LOGIN CHECK SCRIPT -->
<script>
  const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
  const loginUrl = "{% url 'login' %}";

  document.addEventListener("DOMContentLoaded", () => {
    // Protect Upload Screenshot
    const uploadContainer = document.getElementById("uploadContainer");
    const uploadInput = document.getElementById("uploadInput");

    uploadContainer.addEventListener("click", (e) => {
        if (!isAuthenticated) {
            e.preventDefault();
            window.location.href = `${loginUrl}?next=${window.location.pathname}#upload-section`;
            return;
        }
        uploadInput.click();
    });

    // Protect Manual Add Expense
    const expenseForm = document.getElementById("expenseForm");
    expenseForm.addEventListener("submit", (e) => {
        if (!isAuthenticated) {
            e.preventDefault();
            window.location.href = `${loginUrl}?next=${window.location.pathname}#upload-section`;
        }
    });
  });
</script>

<!-- Date & Time Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("expense-date").value = today;

  const timeSpan = document.getElementById("time");
  const daySpan = document.getElementById("day");
  const dateSpan = document.getElementById("date");

  function updateDateTime() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2,'0');
    const minutes = now.getMinutes().toString().padStart(2,'0');
    const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    const day = days[now.getDay()];
    const date = now.toLocaleDateString();

    timeSpan.textContent = `Time : ${hours}:${minutes} hrs`;
    daySpan.textContent = `Day : ${day}`;
    dateSpan.textContent = `Date : ${date}`;
  }

  updateDateTime();
  setInterval(updateDateTime, 60000);

  // Form submit handler
  const form = document.getElementById("expenseForm");
  const floatingModal = document.getElementById("floatingModal");
  const viewDashboardBtn = document.getElementById("viewDashboardBtn");

  form.addEventListener("submit", function(e) {
    e.preventDefault();

    fetch(form.action, {
      method: 'POST',
      body: new FormData(form),
    }).then(res => {
      if(res.ok) {
        floatingModal.style.opacity = "1";
        floatingModal.style.transform = "translate(-50%, -12px)";
        form.reset();
        document.getElementById("expense-date").value = today;
        setTimeout(() => {
          floatingModal.style.opacity = "0";
          floatingModal.style.transform = "translate(-50%, -2px)";
        }, 3000);
      } else {
        alert("Error adding expense");
      }
    }).catch(err => alert("Error: "+err));
  });

  viewDashboardBtn.addEventListener("click", () => {
    window.location.href = "{% url 'dashboard' %}";
  });
});
</script>

<!-- Upload Image Script with Overlay & Spinner -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const uploadInput = document.getElementById("uploadInput");
    const uploadOverlay = document.getElementById("uploadOverlay");

    // ‚úÖ Add references for displaying OCR result
    const resultBox = document.getElementById("ocrResult");
    const merchantEl = document.getElementById("merchant");
    const amountEl = document.getElementById("amount");
    const dateEl = document.getElementById("date");
    const categoryEl = document.getElementById("category");

    uploadInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append("image", file);

        // Show overlay with spinner
        uploadOverlay.style.opacity = "1";
        uploadOverlay.style.pointerEvents = "auto";

        try {
            const response = await fetch("{% url 'upload_expense_image' %}", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                }
            });

            const data = await response.json();

            if (!data.error) {
                // ‚úÖ Update the result section instead of alert
                merchantEl.textContent = data.merchant || "Unknown";
                amountEl.textContent = data.amount || "0.00";
                dateEl.textContent = data.date || "-";
                categoryEl.textContent = data.category || "Other";
                document.getElementById("uploadContent").style.display = "none";
                resultBox.classList.remove("hidden");
            } else {
                // Optional: show error message inside resultBox
                resultBox.classList.remove("hidden");
                merchantEl.textContent = "Upload failed";
                amountEl.textContent = "-";
                dateEl.textContent = "-";
                categoryEl.textContent = data.error;
            }

        } catch (err) {
            console.error(err);
        } finally {
            // Hide overlay
            uploadOverlay.style.opacity = "0";
            uploadOverlay.style.pointerEvents = "none";
            uploadInput.value = ""; // Reset input
        }
    });

    function getCSRFToken() {
        const name = "csrftoken";
        return document.cookie.split("; ").find(r => r.startsWith(name+"="))?.split("=")[1];
    }
});
</script>

{% endblock %}
