{% extends 'base.html' %}
{% block title %}Dashboard - Smart Expense Tracker{% endblock %}
{% load static %}
{% block content %}

<section class="max-w-7xl mx-auto p-6 text-white">
  <h1 class="text-4xl font-bold mb-6 text-center">Expense Dashboard</h1>

  <!-- ðŸ’° Budget & Summary Section -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-gray-900 p-6 rounded-2xl shadow-md flex flex-col justify-between">
      <div>
        <h2 class="text-xl font-semibold mb-2">Total Expenses</h2>
        <p class="text-3xl font-bold text-red-400">â‚¹{{ total_expenses }}</p>
      </div>
      <a href="{% url 'home' %}#add-expense" 
         class="mt-4 inline-block bg-green-600 hover:bg-green-700 px-4 py-2 rounded font-semibold text-center">
        Add Expense
      </a>
    </div>
    <div class="bg-gray-900 p-6 rounded-2xl shadow-md">
      <h2 class="text-xl font-semibold mb-2">Remaining Balance</h2>
      <p class="text-3xl font-bold text-green-400">â‚¹{{ remaining_balance }}</p>
    </div>
    <div class="bg-gray-900 p-6 rounded-2xl shadow-md">
      <h2 class="text-xl font-semibold mb-2">Monthly Budget</h2>
      <form method="POST" action="{% url 'set_budget' %}" class="flex items-center gap-3">
        {% csrf_token %}
        <input
          type="number"
          name="budget"
          value="{{ monthly_budget }}"
          class="p-2 rounded bg-gray-800 text-white w-32"
        />
        <button
          type="submit"
          class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded font-semibold"
        >
          Set
        </button>
      </form>
    </div>
  </div>

  <!-- ðŸ“ˆ Charts Section -->
  <div class="grid w-5/6 grid-cols-1 md:grid-cols-2 gap-14 mb-10 flex justify-center">
    <div class="bg-gray-900 p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold mb-4">Monthly Expense Chart for this year -</h2>
      <canvas id="monthChart"></canvas>
    </div>
    <div class="bg-gray-900 p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold mb-4">Category-wise Expense for this month -</h2>
      <canvas id="categoryChart"></canvas>
    </div>
  </div>

  <!-- ðŸ§¾ Recent Transactions -->
  <h2 class="text-2xl font-bold mb-3">Recent Transactions</h2>

  <!-- ðŸ”½ Month Filter -->
  <form id="filter-form" method="get" class="mb-4">
    <label for="month" class="text-white font-medium">Filter by Month:</label>
    <select
      name="month"
      id="month"
      class="ml-2 p-2 rounded bg-gray-800 text-white"
    >
      <option value="all" {% if selected_month == 'all' %}selected{% endif %}>All</option>
      {% for m in month_names %}
      <option value="{{ forloop.counter }}" {% if selected_month == forloop.counter|stringformat:'s' %}selected{% endif %}>
        {{ m }}
      </option>
      {% endfor %}
    </select>
  </form>

  <!-- ðŸ’° Transactions Table -->
  <div id="transactions-table" class="overflow-x-auto bg-gray-900 rounded-lg shadow-md">
    <table class="min-w-full text-left text-white">
      <thead class="bg-gray-800">
        <tr>
          <th class="p-3">Date</th>
          <th class="p-3">Category</th>
          <th class="p-3">Description</th>
          <th class="p-3">Amount (â‚¹)</th>
          <th class="p-3 text-center">Action</th>
        </tr>
      </thead>
      <tbody>
        {% for expense in expenses %}
       

        <tr class="border-b border-gray-700 hover:bg-gray-800 transition">
          <td class="p-3">{{ expense.date }}</td>
          <td class="p-3">{{ expense.category }}</td>
          <td class="p-3">{{ expense.merchant }}</td>
          <td class="p-3">{{ expense.amount }}</td>
          <td class="p-3 text-center">
            <button
              class="text-red-400 hover:text-red-600 font-semibold delete-btn"
              data-id="{{ expense.id }}"
            >
              Delete
            </button>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="p-3 text-center text-gray-400">No transactions found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<!-- ðŸ“Š Charts Script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

<script>
  // --- Monthly Expense Bar Chart ---
  const monthCtx = document.getElementById('monthChart').getContext('2d');
  new Chart(monthCtx, {
    type: 'bar',
    data: {
      labels: {{ month_names|safe }},
      datasets: [{
        label: 'Monthly Expenses (â‚¹)',
        data: {{ month_values|safe }},
        backgroundColor: 'rgba(59,130,246,0.7)',
      }]
    },
    options: {
      scales: { y: { beginAtZero: true } },
      plugins: {
        legend: { display: false }
      }
    }
  });

  // --- Category Pie Chart ---
  const categoryCtx = document.getElementById('categoryChart').getContext('2d');
  const categoryLabels = {{ category_labels|safe }};
  const categoryValues = {{ category_values|safe }};

  // Fixed unique colors
  const categoryColors = [
      '#3b82f6', '#22c55e', '#ef4444', '#eab308', 
      '#8b5cf6', '#06b6d4', '#f97316', '#f43f5e',
      '#a3e635', '#6366f1'
  ];
  while(categoryColors.length < categoryLabels.length){
      categoryColors.push('#' + Math.floor(Math.random()*16777215).toString(16));
  }

  new Chart(categoryCtx, {
      type: 'pie',
      data: {
          labels: categoryLabels,
          datasets: [{
              data: categoryValues,
              backgroundColor: categoryColors.slice(0, categoryLabels.length)
          }]
      },
      options: {
          responsive: true,
          plugins: {
              legend: {
                  position: 'right',
                  labels: { color: 'white' }
              },
              tooltip: {
                  callbacks: {
                      label: function(context){
                          return `${context.label}: â‚¹${context.parsed}`;
                      }
                  }
              },
              datalabels: {
                  color: 'white',
                  formatter: (value, ctx) => `â‚¹${value}`
              }
          }
      },
      plugins: [ChartDataLabels]
  });

</script>

<!-- âš™ï¸ AJAX Script -->
<script>
document.getElementById('month').addEventListener('change', function() {
  const month = this.value;
  fetch(`?month=${month}`)
    .then(res => res.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      document.querySelector('#transactions-table').innerHTML =
        doc.querySelector('#transactions-table').innerHTML;
    });
});

// ðŸ—‘ï¸ Delete button with AJAX
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('delete-btn')) {
    const id = e.target.getAttribute('data-id');
    fetch(`/delete-expense/${id}/`)
      .then(() => location.reload());
  }
});
</script>

{% endblock %}
